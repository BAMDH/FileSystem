
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi WebDrive</title>
    <link rel="stylesheet" th:href="@{/css/drive.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


</head>
<body>

<!-- Barra superior -->
<header class="header">
    <h1>Mi WebDrive</h1>
    <div class="user-info">
        <span th:text="${usuario}">Usuario</span>
        <button onclick="logout()">Salir</button>
    </div>
</header>

<!-- Contenedor general -->
<div class="container">

    <!-- Barra lateral -->
    <aside class="sidebar">
        <button onclick="irAtras()" class="btn-back">
        <i class="fas fa-arrow-left"></i> Volver
    </button>
        <button onclick="mostrarModalCrearArchivo()">+ Archivo</button>
        <button onclick="crearDirectorio()">+ Carpeta</button>
        <button onclick="subirArchivo()">Subir</button>
<input type="text" id="inputRutaManual" placeholder="Ingrese la ruta para subir" style="width: 100%; margin-top: 8px; padding: 5px;" />


        <hr>
        
    </aside>

    <!-- Vista de archivos -->
    <main class="file-view">
        <div class="path-bar">
            Ruta: <span id="rutaActual" th:text="${rutaActual}">/</span>
        </div>
<!-- Acciones sobre elementos seleccionados -->
<!-- Acciones sobre elementos seleccionados -->
<div class="actions-bar">
    <input type="text" id="Destino" placeholder="Destino" />
    <button onclick="borrarSeleccionados()"><i class="fa fa-trash"></i> Borrar</button>
    <button onclick="compartirSeleccionados()"><i class="fa fa-share-alt"></i> Compartir</button>
    <button onclick="copiarSeleccionados()"><i class="fa fa-copy"></i> Copiar</button>
    <button onclick="moverSeleccionados()"><i class="fa fa-arrows-alt"></i> Mover</button>
    <button onclick="descargarSeleccionados()"><i class="fa fa-download"></i> Descargar</button>

</div>



        <!-- Sección de archivos actualizada -->
    <div class="grid">
       <!-- Carpetas -->
<div th:each="carpeta : ${carpetas}" 
     class="item folder" 
     th:attr="data-carpeta=${carpeta.name}">
    
    <input type="checkbox" class="item-checkbox" th:attr="data-nombre=${carpeta.name}">
    
    <div onclick="abrirCarpeta(this.parentElement.getAttribute('data-carpeta'))">
        <i class="fa fa-folder fa-3x"></i>
        <div class="item-name" th:text="${carpeta.name}">Carpeta</div>
    </div>
</div>

<!-- Archivos -->
<div th:each="archivo : ${archivos}" 
     class="item file" 
     th:attr="data-archivo=${archivo.name + '.' + archivo.extension}">
    
    <input type="checkbox" class="item-checkbox" 
           th:attr="data-nombre=${archivo.name + '.' + archivo.extension}">
    
    <div onclick="verArchivo(this.parentElement.getAttribute('data-archivo'))">
        <i class="fa fa-file-alt fa-3x"></i>
        <div class="item-name">
            <span th:text="${archivo.name}"></span>.<span th:text="${archivo.extension}"></span>
        </div>
    </div>
</div>

    </div>
    </main>
</div>


<!-- Modal para crear archivo -->
<div id="modalCrearArchivo" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalCrearArchivo()">&times;</span>
        <h2>Crear nuevo archivo</h2>
        <form id="formCrearArchivo">
            <div class="form-group">
                <label for="nombreArchivo">Nombre del archivo:</label>
                <input type="text" id="nombreArchivo" required>
            </div>
            <div class="form-group">
                <label for="extensionArchivo">Extensión:</label>
                <input type="text" id="extensionArchivo" required>
            </div>
            <div class="form-group">
                <label for="contenidoArchivo">Contenido:</label>
                <textarea id="contenidoArchivo" rows="5" required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" onclick="cerrarModalCrearArchivo()">Cancelar</button>
                <button type="button" onclick="enviarArchivo()">Crear</button>
            </div>
        </form>
    </div>
</div>


<script>

     // Función para mostrar el modal de crear archivo
    function mostrarModalCrearArchivo() {
        document.getElementById('modalCrearArchivo').style.display = 'block';
    }
    
    // Función para cerrar el modal de crear archivo
    function cerrarModalCrearArchivo() {
        document.getElementById('modalCrearArchivo').style.display = 'none';
        document.getElementById('formCrearArchivo').reset();
    }
    
    // Función para enviar los datos del archivo al servidor
    function enviarArchivo() {
        console.log("enviando el archivo")
        const nombreArchivo = document.getElementById('nombreArchivo').value.trim();
        const extension = document.getElementById('extensionArchivo').value.trim();
        const contenido = document.getElementById('contenidoArchivo').value.trim();
        const rutaDestino = document.getElementById('rutaActual').textContent;
        const usuario = document.querySelector('.user-info span').textContent;
        
        if (!nombreArchivo || !extension || !contenido) {
            alert('Por favor complete todos los campos');
            return;
        }
        
        const data = {
            usuario: usuario,
            nombreArchivo: nombreArchivo,
            extension: extension,
            contenido: contenido,
            rutaDestino: rutaDestino
        };
        
        fetch('http://localhost:3000/api/crear-archivo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.text();
        })
        .then(message => {
            alert(message);
            cerrarModalCrearArchivo();
            window.location.reload(); // Recargar para ver el nuevo archivo
        })
        .catch(error => {
            alert('Error al crear el archivo: ' + error.message);
        });
    }






   

    function obtenerSeleccionados() {
        const seleccionados = [];
        document.querySelectorAll('.item-checkbox:checked').forEach(cb => {
            seleccionados.push(cb.getAttribute('data-nombre'));
        });
        return seleccionados;
    }
function borrarSeleccionados() {
    const seleccionados = obtenerSeleccionados();
    if (seleccionados.length === 0) {
        alert("Selecciona al menos un archivo o carpeta para borrar.");
        return;
    }

    const archivos = [];
    const carpetas = [];

    seleccionados.forEach(nombre => {
        if (nombre.includes('.')) { // asumimos archivo con extensión
            archivos.push(nombre);
        } else {
            carpetas.push(nombre);
        }
    });

    const data = {
        archivos: archivos,
        carpetas: carpetas
    };

    fetch('/borrar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(resp => resp.text())
    .then(msg => {
        alert("Respuesta del servidor: " + msg);
        // Opcional: recargar la página o actualizar lista de archivos
        window.location.reload();
    })
    .catch(err => {
        alert("Error al borrar: " + err);
    });
}

function descargarSeleccionados() {
    const rutaDestino = document.getElementById('Destino').value.trim();
    if (!rutaDestino) {
        alert("Debes indicar la ruta destino.");
        return;
    }

    const seleccionados = obtenerSeleccionados();
    if (seleccionados.length === 0) {
        alert("Selecciona al menos un archivo o carpeta para descargar.");
        return;
    }

    const archivos = [];
    const carpetas = [];

    seleccionados.forEach(nombre => {
        if (nombre.includes('.')) {
            archivos.push(nombre);
        } else {
            carpetas.push(nombre);
        }
    });

    const data = {
        archivos: archivos,
        carpetas: carpetas,
        rutaDestino: rutaDestino
    };

    fetch('/descargar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(resp => resp.text())
    .then(msg => {
        alert("Respuesta del servidor: " + msg);
        // Puedes recargar o actualizar si es necesario
        // window.location.reload();
    })
    .catch(err => {
        alert("Error al descargar: " + err.message);
    });
}



    function compartirSeleccionados() {
        const usuarioDestino = document.getElementById('Destino').value.trim();
        if (!usuarioDestino) {
            alert("Debes indicar el usuario destino.");
            return;
        }

        const seleccionados = obtenerSeleccionados();
        if (seleccionados.length === 0) {
            alert("Selecciona al menos un archivo o carpeta para compartir.");
            return;
        }

        const archivos = [];
        const carpetas = [];

        // Aquí ajusta la lógica para diferenciar archivos y carpetas
        seleccionados.forEach(nombre => {
            if (nombre.includes('.')) { // Suponemos que los archivos tienen extensión
                archivos.push(nombre);
            } else {
                carpetas.push(nombre);
            }
        });

        // Prepara el JSON para enviar (no envíes rutaActual porque lo toma el backend de sesión)
        const data = {
            usuarioDestino: usuarioDestino,
            archivos: archivos,
            carpetas: carpetas
        };

        fetch('/compartir', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(resp => resp.text())
        .then(msg => {
            alert("Respuesta del servidor: " + msg);
        })
        .catch(err => {
            alert("Error al compartir: " + err);
        });
    }
function copiarSeleccionados() {
    const rutaDestino = document.getElementById('Destino').value.trim();
    if (!rutaDestino) {
        alert("Debes indicar la ruta destino.");
        return;
    }

    const seleccionados = obtenerSeleccionados();
    if (seleccionados.length === 0) {
        alert("Selecciona al menos un archivo o carpeta para copiar.");
        return;
    }

    const archivos = [];
    const carpetas = [];

    seleccionados.forEach(nombre => {
        if (nombre.includes('.')) {
            archivos.push(nombre);
        } else {
            carpetas.push(nombre);
        }
    });

    fetch('/copiar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            rutaDestino: rutaDestino,
            archivos: archivos,
            carpetas: carpetas
        })
    })
    .then(resp => resp.text())
    .then(msg => alert("Respuesta servidor: " + msg))
    .catch(err => alert("Error al copiar: " + err));
}
function moverSeleccionados() {
    const rutaDestino = document.getElementById('Destino').value.trim();
    if (!rutaDestino) {
        alert("Debes indicar la ruta destino.");
        return;
    }

    const seleccionados = obtenerSeleccionados();
    if (seleccionados.length === 0) {
        alert("Selecciona al menos un archivo o carpeta para mover.");
        return;
    }

    const archivos = [];
    const carpetas = [];

    seleccionados.forEach(nombre => {
        if (nombre.includes('.')) {
            archivos.push(nombre);
        } else {
            carpetas.push(nombre);
        }
    });

    fetch('/mover', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            rutaDestino: rutaDestino,
            archivos: archivos,
            carpetas: carpetas
        })
    })
    .then(resp => {
        if (resp.ok) {
            return resp.text();
        } else {
            return resp.text().then(err => { throw new Error(err); });
        }
    })
    .then(msg => {
        alert("Respuesta servidor: " + msg);
        window.location.reload(); // ✅ Refresca la vista
    })
    .catch(err => alert("Error al mover: " + err.message));
}



    function crearArchivo() {
        window.location.href = '/crear-archivo';
    }

    function crearDirectorio() {
        var folder=prompt("Carpeta nueva");
        window.location.href = '/crear-carpeta?carpeta=' + encodeURIComponent(folder);
    }
    
    
    
    
    
    
    function subirArchivo() {
    let rutaManual = document.getElementById('inputRutaManual').value.trim();
    if (!rutaManual) {
        alert("Ingresa la ruta para subir el archivo.");
        return;
    }

    // Solo enviamos la rutaManual como nombreArchivo (si quieres enviar otro dato, agrega)
    const data = {
        nombreArchivo: rutaManual
    };

    fetch("http://localhost:8081/subir-archivo", {  // URL del backend Spring Boot
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(resp => resp.text())
    .then(msg => {
        alert("Respuesta servidor: " + msg);
        window.location.reload(); // ✅ Refresca la vista
    })
    .catch(err => alert("Error al conectar: " + err.message));
}

  function abrirCarpeta(nombre) {
    window.location.href = '/navegar?carpeta=' + encodeURIComponent(nombre);
}

function irAtras() {
    window.location.href = '/volver';
}

    function verArchivo(nombre) {
    console.log("Abriendo archivo:", nombre);
    window.location.href = '/ver?archivo=' + encodeURIComponent(nombre);
}

    function logout() {
        window.location.href = '/logout';
    }

    function cambiarVista(vista) {
        window.location.href = '/' + vista;
    }
</script>

</body>
</html>